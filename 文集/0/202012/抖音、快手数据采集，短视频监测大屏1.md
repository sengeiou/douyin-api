# 抖音、快手数据采集，短视频监测大屏


 
本文介绍在数据采集过程中不可或缺的一枚神器——数据采集监控大屏，如果想了解数据采集过程中的一些技术，欢迎查阅我的另外几篇文章，文末附有两篇数据采集文章的链接。先看下面三张图：
![image.png](https://cdn.nlark.com/yuque/0/2020/png/97322/1608172836099-9a6eb750-0d2b-4eda-b8cd-c2b8cb08363a.png#align=left&display=inline&height=332&name=image.png&originHeight=664&originWidth=863&size=360283&status=done&style=none&width=431.5)
![image.png](https://cdn.nlark.com/yuque/0/2020/png/97322/1608172852477-037cf39d-caa4-45e6-bc33-b0abdbb9a57b.png#align=left&display=inline&height=337&name=image.png&originHeight=673&originWidth=923&size=584885&status=done&style=none&width=461.5)
![image.png](https://cdn.nlark.com/yuque/0/2020/png/97322/1608172869381-c52c04c8-f6ec-45e3-b2dc-9847fcd29f67.png#align=left&display=inline&height=350&name=image.png&originHeight=699&originWidth=964&size=491992&status=done&style=none&width=482)

>**了解更多短视频直播数据采集分析接口请**[点击查看接口文档](https://docs.qq.com/doc/DU3RKUFVFdVhQbXlR)  

三张图，不同的时间段，对应的日采集数据量分别在10万，30万，110万，不断刷新自己创下的单日采集数据量记录，可能有人会好奇，为什么最后两天采集到的数据量有暴增的趋势，偷偷告诉你们，这两天是新架构设计方案完成之后，开始测试的两天，第一天轻松达到了53W数据，超过之前极大值近两倍，而第二天更是突破了100W，所以，前面的凹槽，就是新架构开发测试的时间了。图片出自数据采集监控大屏，完整图如下：
![image.png](https://cdn.nlark.com/yuque/0/2020/png/97322/1608172892227-936dc715-99e9-48a6-929c-c9bfc1f55e4b.png#align=left&display=inline&height=540&name=image.png&originHeight=1080&originWidth=1920&size=2095878&status=done&style=none&width=960)
通过以上截图可以得知，目前数据平台总共采集了近700W数据，而最多一天采集数据达到了110W以上，日处理任务量达到30W以上，还能查看到不同业务通道采集到的不同数据的数据量。这个大屏建设的初衷就是为了监控数据采集平台各方面的性能，在采集平台性能优化的同时，监控大屏也在不断优化自身的性能，占用越来越少的平台资源，其中最大的优化算是每日采集数据量统计图。而随着数据量的不断增加，不仅平台压力越来越大，监控大屏性能也越来越差，统计到的阻塞数量也越来越多，这个阻塞数目，监控的是内存中线程的阻塞数，如果这个数量越来越多，最直接的后果就是死机。而每天的数据量还在增加，业务也在扩大，硬件资源就那么多，急需寻找新的解决办法，在这种场景下，数据采集平台2.0架构设计横空出世，解决所有阻塞问题，而且将日采集数据量从30万提升到110万，理论值从50万提升到160万。数据采集平台2.0架构设计为将来的数据暴增预留了位置，支持分布式的横向扩展，这样，随着以后数据的增长，升级就变得非常简单了，接下来本篇文章主要介绍这款监控大屏。

 

# 监控大屏简介

 
监控大屏主要运用数据可视化技术，对采集平台进行监控，定时刷新平台运行数据，通过这款监控大屏，曾经发现了平台的一个死锁问题，当时问题非常隐蔽，平台没有报错，数据还在增加，通过大屏，意识到数据增长变得有一点慢了，有几张表没入库数据，后来开始排查，发现了平台死锁问题。如果该问题没被发现，后续造成的损失将变得不可控制。监控大屏功能如下：
1.每日采集数据量：统计平台近期，每天采集到的数据量，以此来判断平台在一段时间内的健康状况和负载情况。可根据该指标制定性能测试计划。
![image.png](https://cdn.nlark.com/yuque/0/2020/png/97322/1608172907459-c1ee6a24-bc7d-4e7e-8c88-b642dc509b4a.png#align=left&display=inline&height=350&name=image.png&originHeight=699&originWidth=964&size=491992&status=done&style=none&width=482)
2.各主机执行任务统计：统计当前小时，各台机器执行任务的数量，以此来判断各个机器的性能以及资源配置。
![image.png](https://cdn.nlark.com/yuque/0/2020/png/97322/1608172920044-b036a796-d7aa-41f2-9477-8bcd20ad57d0.png#align=left&display=inline&height=253&name=image.png&originHeight=505&originWidth=617&size=278064&status=done&style=none&width=308.5)
3.全网数据量：统计整个平台实时数据量，以此来判断平台压力，确定是否需要升级新架构。
![](https://cdn.nlark.com/yuque/0/2020/png/97322/1608172814321-f96799a3-3e81-4ef8-8725-54131c5b616d.png#align=left&display=inline&height=112&originHeight=112&originWidth=942&size=0&status=done&style=none&width=942)
4.当前时间采集数据量：统计当前小时，每张表增加的数据量，对每一类数据是否正确入库做监控。
![image.png](https://cdn.nlark.com/yuque/0/2020/png/97322/1608172939974-17b7a146-047b-4b19-acd0-4b0f2f4dd8ae.png#align=left&display=inline&height=185&name=image.png&originHeight=369&originWidth=941&size=252542&status=done&style=none&width=470.5)
5.全网数据分布：统计平台所有表的数据量，以此来判断各表压力，为后续分库分表提供依据。
![image.png](https://cdn.nlark.com/yuque/0/2020/png/97322/1608172958149-b21e1427-bd89-4a9b-b8f9-5505219d5b3a.png#align=left&display=inline&height=364&name=image.png&originHeight=727&originWidth=1295&size=998327&status=done&style=none&width=647.5)
6.阻塞数统计：统计个主机中，各个程序阻塞的线程数，以此来判断各机器的性能，阻塞越多，内存占用越多，最终将导致机器宕机。理想情况是，此处为空白，即程序运行不阻塞。
![image.png](https://cdn.nlark.com/yuque/0/2020/png/97322/1608172997854-695b4bce-1191-47c2-ae62-305acf7e3b8b.png#align=left&display=inline&height=292&name=image.png&originHeight=583&originWidth=983&size=465348&status=done&style=none&width=491.5)
7.各类任务执行数：统计不同种类任务，不同状态任务的数量，以此来判断平台执行任务的速度以及正确率。
![](https://cdn.nlark.com/yuque/0/2020/png/97322/1608172814372-eb2c755c-3808-4fb4-9ee7-22bfcc8a26f4.png#align=left&display=inline&height=871&originHeight=871&originWidth=264&size=0&status=done&style=none&width=264)
8.采集速度监控，采用仪表盘监控当前实时的数据采集速度，以及监控过程中出现的采集速度峰值，以此来判断平台实时的效率。
![image.png](https://cdn.nlark.com/yuque/0/2020/png/97322/1608173016941-cdebd534-3bd9-4d32-8484-185f2e97ec14.png#align=left&display=inline&height=138&name=image.png&originHeight=276&originWidth=349&size=63236&status=done&style=none&width=174.5)
通过以上八部分实时数据，即可监控整个数据采集平台运行状况。目前该大屏运行超过两个月，以下列举几个常见问题案例：

 

# 案例1

 
如下图所示，待执行任务有1440个，正在执行任务16个，主机执行任务统计图为空，且数据超过1分钟未刷新。
![image.png](https://cdn.nlark.com/yuque/0/2020/png/97322/1608173029565-2fd5a5ea-9b5a-487b-a7bc-32d6a6e90c27.png#align=left&display=inline&height=383&name=image.png&originHeight=766&originWidth=1600&size=1245875&status=done&style=none&width=800)
解析：任务无法执行，当前小时已经没有任务结束
原因及解决方案：
1.任务复杂，短时间内无法执行完成（几乎不可能有这种情况）
2.程序挂起，无法执行任务。需要重启程序
3.内存不足，程序自动结束。需要重启程序
4.机器宕机。需要重启机器。

 

# 案例2

 
如下图，丢弃任务暴增。
![](https://cdn.nlark.com/yuque/0/2020/png/97322/1608172814348-40943de7-582d-4edf-bf00-a368a49ea4cf.png#align=left&display=inline&height=228&originHeight=228&originWidth=194&size=0&status=done&style=none&width=194)
解析：大量任务已达到重试最大次数，或者出现大量已重置用户
原因及解决方案：
1.出现大量已重置用户。检查是否真的出现了大量重置用户，如确实如此，可不处理，平台会定时处理该类数据，只需等待20分钟即可。
2.接口被官方反爬，采集不到数据了。需要升级采集代码，优化采集策略。

 

# 案例3

 
如下图，当前时间采集数据量中，只有一两个表采集到数据且长时间没有新表加入。
![image.png](https://cdn.nlark.com/yuque/0/2020/png/97322/1608173042406-370f72db-30bc-417e-b3a4-5f99463b86a2.png#align=left&display=inline&height=155&name=image.png&originHeight=310&originWidth=788&size=141863&status=done&style=none&width=394)
解析：其他表在当前时间都没有数据入库
原因及解决方案：
1.当前为定向采集时间，只采集指定类型的数据。正常，无需处理。
2.其他类型的数据解析过程出错。检查数据，查看是否会有超长数据，空数据出现，导致解析失败。如：前期采集到重置用户时，导致解析器报错，现已适配。
3.历史数据中已经存在了采集过的数据，数据没有新增。正常，无需处理。
4.个别表锁表。需要排查数据库，杀死死锁进程。

 

# 案例4

 
如下图，各机器整体阻塞较高
![image.png](https://cdn.nlark.com/yuque/0/2020/png/97322/1608173054753-4ec79b00-643d-4d2e-a494-02a81d2f7c6e.png#align=left&display=inline&height=195&name=image.png&originHeight=390&originWidth=687&size=165467&status=done&style=none&width=343.5)
解析：该部分统计每个机器上面每一类程序的阻塞情况
原因及解决方案：
1.同一任务阻塞较高。该任务代码性能不足，需要升级代码性能
2.同一机器不同任务阻塞较高。该机器硬件不足，需要减少任务量或者升级机器性能。

 

# 案例5

 
如下图，机器处理任务不平均，有机器“偷懒”。
![image.png](https://cdn.nlark.com/yuque/0/2020/png/97322/1608173066190-d334a6b0-1047-4529-9c22-6e57457587c5.png#align=left&display=inline&height=227&name=image.png&originHeight=453&originWidth=554&size=178023&status=done&style=none&width=277)
解析：该机器执行任务相对其他机器明显偏少
原因及解决方案：
1.机器硬件性能较其他机器低。升级机器，使用相同配置机器。
2.该机器处理任务较复杂。优化取任务策略，不同类型任务随机获取
3.该机器的进程假死。需要重启该机器上运行的进程。

 

# 案例6
大屏数据更新正常，处理任务正常，但是数据增量较慢。
解析：数据增长较慢，但是处理任务速度正常，应该怀疑是否是由于丢数据引起
原因及解决方案：
1.有数据未解析，直接跳过。需要排查未处理数据的类型。
2.锁表。需要手动释放锁，修改代码，所有的写操作均用主键ID
以上为这两个多月时间中，见过的一些常见案例，此类问题均由该监控大屏抛出，并以解决。




___________________ 

免责申明：此内容仅供学习交流使用，若侵犯贵方权益，请联系作者删除 
